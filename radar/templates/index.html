<!DOCTYPE html>

<html>
    <head>
        <title>Radar.</title>
        <meta charset="utf-8" />

        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>

        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.css">
        <style type="text/css">
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #map {
                position: absolute;
                width: 100%;
                height: 100%;
            }

            #status {
                z-index: 99;
                position: absolute;
                bottom: 1%;
                font-weight: bold;
                width: 100%;
                text-align: center;
            }
        </style>
    </head>

    <body>
        <div id="map" style="width:100%;height:100%:"></div>

        <script>
            $(document).ready(function () {
                var osm = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
                var tilelayer = L.tileLayer('http://a.tile2.opencyclemap.org/transport/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenCycleMap, ' + 'Map data ' + osm
                });
                var map = L.map('map');
                tilelayer.addTo(map);
                map.invalidateSize();
                getLocation();

                function getLocation () {
                    if (navigator.geolocation) {
                        navigator.geolocation.watchPosition(showPosition, errHandler, {timeout: 3000});
                    } else {
                        setStatus('Geolocation is not supported by this browser.');
                    }
                }

                function showPosition(position) {
                    var x = position.coords.latitude;
                    var y = position.coords.longitude;
                    var markerPos = new L.LatLng(x, y);
                    console.log(x, y);

                    $.ajax({type:'POST', url:'/', data:{"position": 'foo'}, success: function (response) {
                            console.log(response);
                    }});
                    map.setView(markerPos, 15);

                    marker = new L.CircleMarker(markerPos).addTo(map);
                }

                function errHandler (err) {
                    if (err.code == 1) {
                        setStatus('Access is denied');
                    } else if (err.code == 2) {
                        setStatus('Position unavailable');
                    }
                }

                function setStatus (statusMsg) {
                    $('#map').append('<div id="status">' + statusMsg + '</div>');
                }

                var ssEvent = new EventSource('/stream');
                ssEvent.onmessage = function (message) {
                    console.log(message);
                }
            });
        </script>
    </body>
</html>
